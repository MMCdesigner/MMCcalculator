<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>at% â†’ wt% Calculator & Density</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

<style>
    body {
        font-family: "Roboto", sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
    }

    .container {
        max-width: 900px;
        margin: 40px auto;
        background: white;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    h2 {
        font-weight: 500;
        text-align: center;
        margin-bottom: 20px;
    }

    .table-container {
        overflow-x: auto;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        /* ç”±æ–¼æ¬„ä½å¢åŠ ï¼Œå°‡æœ€å°å¯¬åº¦èª¿é«˜ */
        min-width: 750px; 
    }

    th, td {
        padding: 12px;
        text-align: center;
        border-bottom: 1px solid #ddd;
    }

    /* Composition æ¬„ä½å°ˆç”¨æ¨£å¼ */
    .comp-column {
        width: 120px;
        min-width: 120px;
    }

    /* at% æ¬„ä½å°ˆç”¨æ¨£å¼ */
    .at-column {
        width: 80px;
        min-width: 80px;
    }
    
    /* Density, wt%, Vol% æ¬„ä½æ¨£å¼ */
    .numeric-column {
        width: 80px;
        min-width: 80px;
    }
    
    select, input[type=number], input[type=text] {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 16px;
    }

    button {
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 8px;
        margin: 8px 4px;
        cursor: pointer;
        transition: 0.2s;
    }

    .btn-primary {
        background-color: #1976d2;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0d47a1;
    }

    .btn-normalize {
        background-color: #00796b;
        color: white;
    }

    .btn-normalize:hover {
        background-color: #004d40;
    }

    .btn-delete {
        background-color: #d32f2f;
        color: white;
        padding: 6px 10px;
    }

    .total-box {
        margin-top: 10px;
        font-size: 18px;
        font-weight: 500;
        text-align: right;
    }

    /* å­—ä¸²ç”Ÿæˆå€å¡Šæ¨£å¼ */
    .string-generator {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #ccc;
    }

    .result-box {
        margin-top: 15px;
        padding: 10px;
        background-color: #e6e6fa; /* æ·ºç´«è‰²å¼·èª¿çµæœ */
        border-radius: 6px;
        font-size: 18px;
        font-weight: 700;
        text-align: center;
    }
    
    .string-output {
        margin-top: 5px;
        padding: 10px;
        background-color: #e9e9e9;
        border-radius: 6px;
        font-size: 16px;
        word-break: break-all;
        font-weight: 500;
    }
    
    .string-label {
        margin-top: 15px;
        font-weight: 500;
    }

    @media (max-width: 600px) {
        button { width: 100%; }
    }
</style>
</head>
<body>

<div class="container">
    <h2>Metal Oxide Composition & Density Calculator</h2>

    <div class="table-container">
    <table id="elementsTable">
        <tr>
            <th class="comp-column">Composition</th> 
            <th class="at-column">at%</th>
            <th class="numeric-column">Atomic W</th>
            <th class="numeric-column">Density (g/cmÂ³)</th>
            <th class="numeric-column">wt%</th>
            <th class="numeric-column">Vol%</th>
            <th>Delete</th>
        </tr>
    </table>
    </div>

    <button class="btn-primary" onclick="addRow()">Add Composition</button>
    <button class="btn-normalize" onclick="autoNormalize()">Normalize to 100%</button>
    <button class="btn-primary" onclick="calculateAndGenerate()">Calculate All</button> 

    <div class="total-box">
        Total at%: <span id="totalAt">0</span>%
    </div>
    
    <div class="result-box">
        ç†è«–å¯†åº¦ (Theoretical Density): <span id="theoreticalDensity"> - </span> g/cmÂ³
    </div>

    <div class="string-generator">
        <h3>ğŸ’¬ ç”Ÿæˆçš„æˆåˆ†å­—ä¸²</h3>
        
        <p class="string-label">at% å­—ä¸²:</p>
        <div class="string-output" id="atStringOutput">è«‹å…ˆè¨ˆç®—</div>
        
        <p class="string-label">wt% å­—ä¸²:</p>
        <div class="string-output" id="wtStringOutput">è«‹å…ˆè¨ˆç®—</div>
    </div>
    </div>

<script>
// å…ƒç´ æ•¸æ“šçµæ§‹ï¼š{ "å…ƒç´ ": { AW: åŸå­é‡, D: å¯†åº¦ } }
const elementData = {
    "Al": { AW: 26.9815, D: 2.7 },
    "B": { AW: 10.81, D: 2.46 },
    "Co": { AW: 58.9332, D: 8.9 },
    "Cr": { AW: 51.9961, D: 7.19 },
    "Cu": { AW: 63.564, D: 8.96 },
    "Fe": { AW: 55.845, D: 7.87 },
    "Mn": { AW: 54.938, D: 7.43 },
    "Mo": { AW: 95.96, D: 10.2 },
    "Nb": { AW: 92.9064, D: 8.57 },
    "Ni": { AW: 58.6934, D: 8.9 },
    "Pt": { AW: 195.084, D: 21.45 },
    "Ru": { AW: 101.07, D: 12.37 },
    "Ta": { AW: 180.948, D: 16.6 },
    "Ti": { AW: 47.867, D: 4.506 },
    "W": { AW: 183.84, D: 19.25 },
    "B2O3": { AW: 69.618, D: 2.55 },
    "CoO": { AW: 74.933, D: 6.45 },
    "Co3O4": { AW: 240.797, D: 6.11 },
    "Cr2O3": { AW: 151.99, D: 5.21 },
    "MgO": { AW: 40.304, D: 3.58 },
    "SiO2": { AW: 60.84, D: 2.3 },
    "TiO": { AW: 63.866, D: 4.95 },
    "TiO2": { AW: 79.866, D: 4.23 },
    "BN": { AW: 24.817, D: 3.45 },
};

function addRow() {
    let table = document.getElementById("elementsTable");
    let row = table.insertRow(-1);

    // 0. Composition
    let cell0 = row.insertCell(0);
    cell0.classList.add("comp-column");
    let select = document.createElement("select");
    for (let key in elementData) {
        let opt = document.createElement("option");
        opt.value = key;
        opt.innerHTML = key;
        select.appendChild(opt);
    }
    // è¨­ç½® onchange äº‹ä»¶ï¼Œä»¥ä¾¿é¸ä¸­ä¸åŒæˆåˆ†æ™‚ï¼ŒAtomic W å’Œ Density è‡ªå‹•æ›´æ–°
    select.onchange = () => {
        const elm = select.value;
        const data = elementData[elm];
        
        // æ›´æ–° Atomic W æ¬„ä½ (ç¬¬ 2 å€‹ cell)
        row.cells[2].innerHTML = data.AW.toFixed(4);
        // æ›´æ–° Density æ¬„ä½ (ç¬¬ 3 å€‹ cell)
        row.cells[3].innerHTML = data.D.toFixed(3);
        
        // é‡æ–°è¨ˆç®— (å¯é¸ï¼Œé¿å…æ¯æ¬¡é¸å–®è®Šå‹•éƒ½é‡ç®—)
        // calculateAndGenerate(); 
    };
    cell0.appendChild(select);
    
    // 1. at%
    let cell1 = row.insertCell(1);
    cell1.classList.add("at-column"); 
    let input = document.createElement("input");
    input.type = "number";
    input.value = 0;
    input.min = 0;
    input.oninput = updateTotalAt;
    cell1.appendChild(input);

    // 2. Atomic W (åªè®€)
    let cell2 = row.insertCell(2);
    cell2.classList.add("numeric-column");
    // é è¨­å€¼
    cell2.innerHTML = elementData[select.value].AW.toFixed(4);

    // 3. Density (åªè®€)
    let cell3 = row.insertCell(3);
    cell3.classList.add("numeric-column");
    // é è¨­å€¼
    cell3.innerHTML = elementData[select.value].D.toFixed(3);

    // 4. wt% (çµæœ)
    row.insertCell(4).innerHTML = "-";

    // 5. Vol% (çµæœ)
    row.insertCell(5).innerHTML = "-";

    // 6. Delete
    let cell6 = row.insertCell(6);
    let del = document.createElement("button");
    del.className = "btn-delete";
    del.innerHTML = "X";
    del.onclick = () => { row.remove(); updateTotalAt(); };
    cell6.appendChild(del);
}

function updateTotalAt() {
    let rows = document.getElementById("elementsTable").rows;
    let total = 0;

    for (let i = 1; i < rows.length; i++) {
        // at% æ¬„ä½åœ¨ç¬¬ 1 å€‹ cell
        let v = parseFloat(rows[i].cells[1].children[0].value);
        total += isNaN(v) ? 0 : v;
    }

    document.getElementById("totalAt").innerHTML = total.toFixed(3);
    return total;
}

function autoNormalize() {
    let total = updateTotalAt();
    if (total === 0) return;

    let rows = document.getElementById("elementsTable").rows;

    for (let i = 1; i < rows.length; i++) {
        // at% æ¬„ä½åœ¨ç¬¬ 1 å€‹ cell
        let input = rows[i].cells[1].children[0];
        let val = parseFloat(input.value);
        input.value = ((val / total) * 100).toFixed(3);
    }

    updateTotalAt();
}

/**
 * æ ¸å¿ƒåŠŸèƒ½ï¼šè¨ˆç®— wt%, Vol%ï¼Œç†è«–å¯†åº¦ï¼ŒåŒæ™‚ç”Ÿæˆ at% å’Œ wt% å­—ä¸²ã€‚
 * ç†è«–å¯†åº¦è¨ˆç®—å…¬å¼ (Volume Averaging):
 * Ï_theoretical = 1 / [ Î£ (at% * AW / (AW * Ï)) ] = 1 / [ Î£ (at% / Ï) ] (éœ€ä½¿ç”¨æ­£è¦åŒ– at%)
 * æ­¤è™•æˆ‘å€‘ä½¿ç”¨ wt% åŠ æ¬Šå¹³å‡ï¼š1 / [ Î£ (wt% / Ï) ]
 */
function calculateAndGenerate() {
    let rows = document.getElementById("elementsTable").rows;
    if (rows.length <= 1) { 
        document.getElementById("theoreticalDensity").innerHTML = " - ";
        document.getElementById("atStringOutput").innerHTML = "è«‹æ–°å¢æˆåˆ†ã€‚";
        document.getElementById("wtStringOutput").innerHTML = "è«‹æ–°å¢æˆåˆ†ã€‚";
        return;
    }

    const precision = 3; 

    let totalAtTimesAW = 0;
    let compositions = []; // å„²å­˜ { element, at, AW, D }

    // 1. æ”¶é›†æ•¸æ“šä¸¦è¨ˆç®— Î£ (at% * AW)
    for (let i = 1; i < rows.length; i++) {
        const elm = rows[i].cells[0].children[0].value;
        const at = parseFloat(rows[i].cells[1].children[0].value);
        
        if (isNaN(at) || at < 0 || !(elm in elementData)) {
             document.getElementById("theoreticalDensity").innerHTML = "éŒ¯èª¤ï¼";
             document.getElementById("atStringOutput").innerHTML = "éŒ¯èª¤ï¼šç„¡æ•ˆçš„ at% æˆ–æˆåˆ†ã€‚";
             document.getElementById("wtStringOutput").innerHTML = "éŒ¯èª¤ï¼šç„¡æ•ˆçš„ at% æˆ–æˆåˆ†ã€‚";
             rows[i].cells[4].innerHTML = "éŒ¯èª¤"; // wt%
             rows[i].cells[5].innerHTML = "éŒ¯èª¤"; // Vol%
             return;
        }
        
        const data = elementData[elm];
        const atTimesAW = at * data.AW;
        
        compositions.push({
            element: elm,
            at: at,
            AW: data.AW,
            D: data.D,
            atTimesAW: atTimesAW // åˆ†å­
        });
        totalAtTimesAW += atTimesAW;
    }
    
    if (totalAtTimesAW === 0) {
        document.getElementById("theoreticalDensity").innerHTML = "0";
        document.getElementById("atStringOutput").innerHTML = "at% * AW ç¸½å’Œç‚ºé›¶ã€‚";
        document.getElementById("wtStringOutput").innerHTML = "at% * AW ç¸½å’Œç‚ºé›¶ã€‚";
        return;
    }

    // 2. è¨ˆç®— wt%, Vol%, ç†è«–å¯†åº¦
    let sumWtDivDensity = 0; // Î£ (wt% / Ï)
    let sumVol = 0; // Î£ (at% * AW / D) / totalAW (vol% è¨ˆç®—åˆ†å­)
    
    let atStringParts = [];
    let wtStringParts = [];
    
    for (let i = 0; i < compositions.length; i++) {
        const comp = compositions[i];

        // è¨ˆç®— wt%
        const wt = (comp.atTimesAW / totalAtTimesAW) * 100;
        
        // ç†è«–å¯†åº¦æ‰€éœ€çš„åˆ†å­ (wt% / Ï)
        const wtDivDensity = wt / comp.D;
        sumWtDivDensity += wtDivDensity;

        // Vol% æ‰€éœ€çš„åˆ†å­ (at * AW / D)
        const atAWDivD = comp.atTimesAW / comp.D;
        sumVol += atAWDivD; // é€™æ˜¯è¨ˆç®— Vol% çš„åŸºç¤

        // æ›´æ–°è¡¨æ ¼ä¸­çš„ wt% æ¬„ä½ (ç¬¬ 4 å€‹ cell)
        rows[i + 1].cells[4].innerHTML = wt.toFixed(precision) + "%";
        
        // ç”Ÿæˆ at% å­—ä¸²
        atStringParts.push(`${comp.at.toFixed(precision).replace(/\.?0+$/, '')}${comp.element}`);

        // ç”Ÿæˆ wt% å­—ä¸²
        wtStringParts.push(`${wt.toFixed(precision).replace(/\.?0+$/, '')}${comp.element}`);
    }

    // 3. è¨ˆç®— Vol% (Vol% = [ (at * AW / D) / Î£(at * AW / D) ] * 100)
    for (let i = 0; i < compositions.length; i++) {
        const comp = compositions[i];
        const atAWDivD = comp.atTimesAW / comp.D;
        
        const vol = (atAWDivD / sumVol) * 100;
        
        // æ›´æ–°è¡¨æ ¼ä¸­çš„ Vol% æ¬„ä½ (ç¬¬ 5 å€‹ cell)
        rows[i + 1].cells[5].innerHTML = vol.toFixed(precision) + "%";
    }

    // 4. è¨ˆç®—æœ€çµ‚ç†è«–å¯†åº¦ (wt% åŠ æ¬Šå¹³å‡æ³•: Ï_th = 1 / Î£ (wt% / Ï))
    const theoreticalDensity = 1 / (sumWtDivDensity / 100); // å› ç‚º sumWtDivDensity æ˜¯ç”¨ç™¾åˆ†æ¯” (0-100) è¨ˆç®—çš„ï¼Œéœ€é™¤ä»¥ 100 æ­£è¦åŒ–
    
    // 5. è¼¸å‡ºçµæœ
    document.getElementById("theoreticalDensity").innerHTML = theoreticalDensity.toFixed(3);
    document.getElementById("atStringOutput").innerHTML = `${atStringParts.join('-')} at%`;
    document.getElementById("wtStringOutput").innerHTML = `${wtStringParts.join('-')} wt%`;
    
    // å¦‚æœæ‚¨éœ€è¦å„²å­˜åŠŸèƒ½ï¼Œå¯ä»¥åœ¨é€™è£¡å‘¼å« saveData()
}

// ç¢ºä¿ç¶²é è¼‰å…¥æ™‚è‡³å°‘æœ‰ä¸€è¡Œ
addRow();
</script>

</body>
</html>
